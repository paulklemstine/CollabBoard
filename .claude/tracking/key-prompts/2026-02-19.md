# Key Prompts — 2026-02-19

## [2026-02-19] — AI Tools Upgrade: Metadata Labels + 5 New Tools
**Category**: feature
**Context**: AI agent creates board objects but has no way to annotate what each object represents or group related objects. Additionally, the agent lacked read/query tools for efficient board interaction.
**The Prompt**: Implement the plan for AI metadata labels (aiLabel/aiGroupId on all create tools) with L-key toggle overlay, plus 5 new tools (getObject, updateFrameTitle, searchObjects, getBoardSummary, deleteObjects).
**Why It Worked**: Clear plan with exact file list, interface changes, and implementation order. Each step was independent enough to execute sequentially without ambiguity.
**Prior Attempts That Failed**: N/A — first implementation pass.

## [2026-02-19] — Board Preview Screenshots via html-to-image
**Category**: feature
**Context**: Dashboard board previews used low-fidelity SVG approximations that couldn't render GIF stickers (HTML overlays outside Konva canvas). Needed real screenshots.
**The Prompt**: Implement plan to use html-to-image to capture the Board's stage container as JPEG, upload to Firebase Storage, store URL on board metadata, and display in dashboard.
**Why It Worked**: Plan correctly identified that stage.toDataURL() won't capture HTML overlays and chose html-to-image to capture the full DOM container. Fire-and-forget capture on board exit + 30s debounced interval keeps thumbnails fresh without blocking UX.
**Prior Attempts That Failed**: N/A — first implementation pass.

## [2026-02-19] — Optimize AI Prompt Token Usage
**Category**: architecture
**Context**: Every AI request sent ~6,500+ fixed tokens (system prompt + tool defs) plus full board state as pretty-printed JSON (1,500-15,000+ tokens). For a 50-object board with 3 tool loop iterations, ~60,000+ input tokens per request.
**The Prompt**: Implement plan to optimize token usage: classify prompts as creation-only vs context-needed, skip/summarize board state accordingly, condense SYSTEM_PROMPT, trim tool descriptions, and use compact serialization (short keys, strip defaults) in tool results.
**Why It Worked**: Four independent optimization layers (prompt classification, system prompt condensing, tool desc trimming, compact serialization) that compound multiplicatively across tool loop iterations. Creation-only requests (most common) now send zero board state.
**Prior Attempts That Failed**: N/A — first implementation pass.

## [2026-02-19] — Duplicate/Copy-Paste + Fix Hover Handle UX
**Category**: feature
**Context**: Board objects have hover-revealed action buttons positioned outside component bounds. Moving toward buttons triggers onMouseLeave before onMouseEnter, causing buttons to unmount. Additionally, no duplicate/copy/paste functionality existed.
**The Prompt**: Implement plan for hit-expansion Rect fix on all 5 object components, pure duplicateObjects utility, batchAddObjects service, selectMultiple hook method, Ctrl+C/V/D keyboard shortcuts with clipboard ref, and duplicate buttons on each component + SelectionOverlay.
**Why It Worked**: Plan correctly identified the root cause (race between conditionally-rendered buttons and Group hit region) and the fix (always-rendered transparent Rect extending 30px beyond bounds). Duplication logic handled edge cases: connector endpoint remapping, parentId remapping, and incremental updatedAt for z-ordering.
**Prior Attempts That Failed**: N/A — first implementation pass.

## [2026-02-19] — Frame Drop: Reject Oversized Objects
**Category**: feature
**Context**: When objects are dragged into frames, oversized objects were automatically scaled down to fit, which felt janky. Users wanted oversized objects rejected outright, with clear visual feedback during drag.
**The Prompt**: Implement plan to change hoveredFrameId/groupHoveredFrameId from string|null to {id, fits}|null, add fitsInFrame/groupFitsInFrame helpers, remove all scaleToFitFrame scaling on drop (reject instead), and update FrameComponent with green/red Tween animations + emoji overlays for accept/reject states.
**Why It Worked**: Clean state shape change ({id, fits} vs plain string) propagated naturally through the chain: containment.ts helpers → useBoard/useMultiSelect drag handlers → App.tsx prop computation → FrameComponent visual feedback. Removing scaling logic was pure deletion, reducing complexity.
**Prior Attempts That Failed**: N/A — first implementation pass.

## [2026-02-19] — Undo/Redo System Implementation
**Category**: feature
**Context**: Whiteboard had no undo/redo. Users had no way to revert accidental deletes, wrong drags, or other mistakes — a critical missing feature for any whiteboard tool.
**The Prompt**: "Implement the following plan: Undo/Redo for Toolbar" (with detailed architecture plan for command pattern with full object snapshots)
**Why It Worked**: The plan was comprehensive — specifying exact types (UndoChange/UndoEntry), the snapshot-based approach (structuredClone before/after), which mutations needed instrumentation, and the onResizeEnd/onRotateEnd component callback pattern. Having the full architecture up front meant implementation was mechanical.
**Prior Attempts That Failed**: N/A — first implementation, planned in a prior session.

## [2026-02-19] — Color Picker for Frames (Borderless + Regular)
**Category**: bug-resolution
**Context**: ShapeDrawer color picker correctly dispatched color changes to Firestore for frames and lines, but frame rendering didn't reflect them. Borderless frames hardcoded `fill="transparent"` and hover `stroke="#94a3b8"`. Regular frames' JSX used `frame.borderColor`/`frame.color` correctly, but the Konva Tween animation immediately overwrote them with hardcoded defaults on mount and hover transitions.
**The Prompt**: Plan identifying three precise changes in FrameComponent.tsx: (1) borderless frame JSX uses `frame.color`/`frame.borderColor`, (2) Tween branches become frame-property-aware with borderless conditionals, (3) dependency array includes `frame.borderless`, `frame.color`, `frame.borderColor`.
**Why It Worked**: Root cause analysis correctly identified the Tween as the override mechanism — the JSX attributes were correct but the Tween animation to hardcoded values ran immediately, erasing them. Surgical three-point fix in a single file.
**Prior Attempts That Failed**: N/A — clean implementation from plan.
